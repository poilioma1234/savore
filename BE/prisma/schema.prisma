generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   Int          @id @default(autoincrement())
  email                String       @unique
  passwordHash         String       @map("password_hash")
  fullName             String?      @map("full_name")
  createdAt            DateTime     @default(now()) @map("created_at")
  commissions          Commission[]
  orderItemsAsCreator  OrderItem[]  @relation("CreatorOrderItems")
  orderItemsAsSupplier OrderItem[]  @relation("SupplierOrderItems")
  orders               Order[]
  posts                Post[]
  products             Product[]
  userRoles            UserRole[]
  wallet               Wallet?

  @@map("users")
}

model Role {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Wallet {
  id           Int           @id @default(autoincrement())
  userId       Int           @unique @map("user_id")
  balance      Decimal       @default(0) @db.Decimal(15, 2)
  currency     String        @default("VND")
  createdAt    DateTime      @default(now()) @map("created_at")
  transactions Transaction[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model Transaction {
  id           Int      @id @default(autoincrement())
  walletId     Int      @map("wallet_id")
  amount       Decimal  @db.Decimal(15, 2)
  type         String
  sourceType   String   @map("source_type")
  sourceId     Int?     @map("source_id")
  balanceAfter Decimal  @map("balance_after") @db.Decimal(15, 2)
  status       String   @default("PENDING")
  createdAt    DateTime @default(now()) @map("created_at")
  wallet       Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Product {
  id                Int                @id @default(autoincrement())
  supplierId        Int                @map("supplier_id")
  name              String
  price             Decimal            @db.Decimal(15, 2)
  status            String             @default("ACTIVE")
  createdAt         DateTime           @default(now()) @map("created_at")
  orderItems        OrderItem[]
  supplier          User               @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@map("products")
}

model Post {
  id                Int                @id @default(autoincrement())
  creatorId         Int                @map("creator_id")
  title             String
  videoUrl          String?            @map("video_url")
  status            String             @default("DRAFT")
  createdAt         DateTime           @default(now()) @map("created_at")
  orderItems        OrderItem[]
  creator           User               @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@map("posts")
}

model RecipeIngredient {
  id             Int     @id @default(autoincrement())
  postId         Int     @map("post_id")
  productId      Int     @map("product_id")
  quantityNeeded Decimal @map("quantity_needed") @db.Decimal(10, 2)
  post           Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  product        Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("recipe_ingredients")
}

model Order {
  id         Int         @id @default(autoincrement())
  userId     Int         @map("user_id")
  totalPrice Decimal     @map("total_price") @db.Decimal(15, 2)
  status     String      @default("PENDING")
  createdAt  DateTime    @default(now()) @map("created_at")
  orderItems OrderItem[]
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
}

model OrderItem {
  id                    Int          @id @default(autoincrement())
  orderId               Int          @map("order_id")
  productId             Int          @map("product_id")
  supplierId            Int          @map("supplier_id")
  creatorId             Int?         @map("creator_id")
  sourcePostId          Int?         @map("source_post_id")
  productNameAtPurchase String       @map("product_name_at_purchase")
  priceAtPurchase       Decimal      @map("price_at_purchase") @db.Decimal(15, 2)
  quantity              Decimal      @db.Decimal(10, 2)
  commissionRate        Decimal?     @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount      Decimal?     @map("commission_amount") @db.Decimal(15, 2)
  supplierAmount        Decimal      @map("supplier_amount") @db.Decimal(15, 2)
  createdAt             DateTime     @default(now()) @map("created_at")
  commissions           Commission[]
  creator               User?        @relation("CreatorOrderItems", fields: [creatorId], references: [id])
  order                 Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product               Product      @relation(fields: [productId], references: [id])
  sourcePost            Post?        @relation(fields: [sourcePostId], references: [id])
  supplier              User         @relation("SupplierOrderItems", fields: [supplierId], references: [id])

  @@map("order_items")
}

model Commission {
  id          Int       @id @default(autoincrement())
  orderItemId Int       @map("order_item_id")
  creatorId   Int       @map("creator_id")
  amount      Decimal   @db.Decimal(15, 2)
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now()) @map("created_at")
  creator     User      @relation(fields: [creatorId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("commissions")
}
