generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int          @id @default(autoincrement())
  email                String       @unique
  passwordHash         String       @map("password_hash")
  fullName             String?      @map("full_name")
  description          String?      @db.Text
  address              String?      @db.Text
  latitude             Decimal?     @db.Decimal(10, 8)
  longitude            Decimal?     @db.Decimal(11, 8)
  avatar               String?
  createdAt            DateTime     @default(now()) @map("created_at")
  commissions          Commission[]
  orderItemsAsCreator  OrderItem[]  @relation("CreatorOrderItems")
  orderItemsAsSupplier OrderItem[]  @relation("SupplierOrderItems")
  orders               Order[]
  posts                Post[]
  products             Product[]
  userRoles            UserRole[]
  wallet               Wallet?
  ingredients          Ingredient[] @relation("ProviderIngredients")
  comments             Comment[]
  followers            Follow[]     @relation("Following")
  following            Follow[]     @relation("Follower")
  likes                Like[]

  @@map("users")
}

model Role {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Wallet {
  id           Int           @id @default(autoincrement())
  userId       Int           @unique @map("user_id")
  balance      Decimal       @default(0) @db.Decimal(15, 2)
  currency     String        @default("VND")
  createdAt    DateTime      @default(now()) @map("created_at")
  transactions Transaction[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model Transaction {
  id           Int      @id @default(autoincrement())
  walletId     Int      @map("wallet_id")
  amount       Decimal  @db.Decimal(15, 2)
  type         String
  sourceType   String   @map("source_type")
  sourceId     Int?     @map("source_id")
  balanceAfter Decimal  @map("balance_after") @db.Decimal(15, 2)
  status       String   @default("PENDING")
  createdAt    DateTime @default(now()) @map("created_at")
  wallet       Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Product {
  id         Int         @id @default(autoincrement())
  supplierId Int         @map("supplier_id")
  name       String
  price      Decimal     @db.Decimal(15, 2)
  status     String      @default("ACTIVE")
  createdAt  DateTime    @default(now()) @map("created_at")
  orderItems OrderItem[]
  supplier   User        @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("products")
}

model Post {
  id                String           @id @default(uuid()) @db.Uuid
  userId            Int              @map("user_id")
  linkVideo         String           @map("link_video")
  thumbnail         String?
  name              String
  description       String?          @db.Text
  cookingSteps      String[]         @map("cooking_steps") @default([])
  tagIds            Int[]            @map("tag_ids") @default([])
  status            String           @default("DRAFT")
  rating            Decimal          @default(0) @db.Decimal(3, 1)
  view              Int              @default(0)
  createdAt         DateTime         @default(now()) @map("created_at")
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeItems       RecipeItem[]
  orderItems        OrderItem[]
  comments          Comment[]
  likes             Like[]

  @@map("posts")
}

model Comment {
  id                String           @id @default(uuid()) @db.Uuid
  postId            String           @map("post_id") @db.Uuid
  userId            Int              @map("user_id")
  description       String           @db.Text
  images            String[]         @default([])
  isRatingComment   Boolean          @default(false) @map("is_rating_comment")
  rating            Decimal?         @db.Decimal(2, 1)
  createdAt         DateTime         @default(now()) @map("created_at")
  post              Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Ingredient {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  tag         String
  providerId  Int          @map("provider_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  provider    User         @relation("ProviderIngredients", fields: [providerId], references: [id], onDelete: Cascade)
  recipeItems RecipeItem[]

  @@map("ingredients")
}

model RecipeItem {
  id           String     @id @default(uuid()) @db.Uuid
  postId       String     @map("post_id") @db.Uuid
  ingredientId String     @map("ingredient_id") @db.Uuid
  quantity     Decimal    @db.Decimal(10, 2)
  unit         String?
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@map("recipe_items")
}


model Order {
  id         Int         @id @default(autoincrement())
  userId     Int         @map("user_id")
  totalPrice Decimal     @map("total_price") @db.Decimal(15, 2)
  status     String      @default("PENDING")
  createdAt  DateTime    @default(now()) @map("created_at")
  orderItems OrderItem[]
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
}

model OrderItem {
  id                    Int          @id @default(autoincrement())
  orderId               Int          @map("order_id")
  productId             Int          @map("product_id")
  supplierId            Int          @map("supplier_id")
  creatorId             Int?         @map("creator_id")
  sourcePostId          String?      @map("source_post_id") @db.Uuid
  productNameAtPurchase String       @map("product_name_at_purchase")
  priceAtPurchase       Decimal      @map("price_at_purchase") @db.Decimal(15, 2)
  quantity              Decimal      @db.Decimal(10, 2)
  commissionRate        Decimal?     @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount      Decimal?     @map("commission_amount") @db.Decimal(15, 2)
  supplierAmount        Decimal      @map("supplier_amount") @db.Decimal(15, 2)
  createdAt             DateTime     @default(now()) @map("created_at")
  commissions           Commission[]
  creator               User?        @relation("CreatorOrderItems", fields: [creatorId], references: [id])
  order                 Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product               Product      @relation(fields: [productId], references: [id])
  sourcePost            Post?        @relation(fields: [sourcePostId], references: [id])
  supplier              User         @relation("SupplierOrderItems", fields: [supplierId], references: [id])

  @@map("order_items")
}

model Commission {
  id          Int       @id @default(autoincrement())
  orderItemId Int       @map("order_item_id")
  creatorId   Int       @map("creator_id")
  amount      Decimal   @db.Decimal(15, 2)
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now()) @map("created_at")
  creator     User      @relation(fields: [creatorId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("commissions")
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tags")
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int      @map("follower_id")
  followingId Int      @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  postId    String   @map("post_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("likes")
}
